Fatal error: exception Failure("defer statement inside of while block")